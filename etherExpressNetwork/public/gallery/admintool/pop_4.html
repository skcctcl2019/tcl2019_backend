<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">

  <link rel="stylesheet" href="../../lib/jui/css/ui.min.css" />
  <link id="ui_theme" rel="stylesheet" href="../../lib/jui/css/ui-jennifer.min.css" />
  <link rel="stylesheet" href="../../lib/jui/css/grid.min.css" />
  <link id="grid_theme" rel="stylesheet" href="../../lib/jui/css/grid-jennifer.min.css" />
  <script src="../../lib/jquery-1.8.0.min.js"></script>
  <script src="../../lib/jui/js/core.min.js"></script>
  <script src="../../lib/jui/js/ui.min.js"></script>
  <script src="../../lib/jui/js/grid.min.js"></script>
  <script src="../../lib/jui/js/chart.min.js"></script>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
  <link href="../../gallery/admintool/index.css" rel="stylesheet" type="text/css" />
  <link id="index_theme" href="../../gallery/admintool/index-jennifer.css" rel="stylesheet" type="text/css" />
  <style>
    h3 {
      text-align: left;
      margin-left: 20px;
    }

    tr.border_bottom td {
      border-bottom: 0.1pt solid rgba(184, 184, 184, 0.849);
    }

    tr.border_bottom th {
      border-bottom: 0.1pt solid rgba(184, 184, 184, 0.849);
    }
  </style>
</head>

<body class="jui">

  <div class="header">
    <div class="logo">
      <i class="icon-menu"></i>
    </div>
    <div class="toolbar">
      <span>Theme</span>
      <span>
        <select onchange="changeTheme(this.value)">
          <option value="jennifer">Jennifer</option>
          <option value="dark">Dark</option>
        </select>
      </span>
      <span style="float:right" onclick="closePop()">
        Close
        <i class="icon-check"></i>
      </span>
    </div>
  </div>
  <div class="container">
    <div class="menu">
      <div class="vmenu ">
        <a href="./pop_1.html">
          <i class="icon-more"></i>사전 정보
          <BR>등록</a>
        <a href="./pop_2.html">
          <i class="icon-bell"></i> 긴급 실종
          <br>신고</a>
        <a href="./pop_3.html">
          <i class="icon-profile"></i>경찰청 DB
          <br>조회</a>
        <a href="./pop_4.html" class="active">
          <i class="icon-search"></i> 실종/보호
          <br>아동조회</a>
        <a href="./pop_5.html">
          <i class="icon-add-dir"></i>실종/보호<br>아동등록</a>
        <a href="./pop_6.html">
          <i class="icon-unhappy"></i>Market</a>
        <a href="./pop_7.html">
          <i class="icon-user"></i> My Page</a>
        <a href="./pop_8.html">
          <i class="icon-gear"></i> Admin </a>
      </div>
    </div>
    <div class="content">
      <div class="content-list">
        <div class="dashboard-first">
          <div class="col col-3">
            <div class="card">
              <div class="title" style="color:#808080;">Today's visitors</div>
              <div class="value">3,352</div>
            </div>
          </div>
          <div class="col col-3">
            <div class="card">
              <div class="title" style="color:#808080;">Total registration</div>
              <div class="value" id="totRegChain" name="totRegChain">364,806</div>
            </div>
          </div>
          <div class="col col-3">
            <div class="card">
              <div class="title" style="color:#808080;">Current Issued Token</div>
              <div class="value" id="totToken" name="totToken">15,610</div>
            </div>
          </div>
          <div class="col col-3">
            <div class="card">
              <div class="title" style="color:#808080;">Your Token</div>
              <div class="value" id="yourToken" name="yourToken">1,250</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="body">
            <h2 class="title" align='center' style="margin-left:0px; font-size:35px;margin-bottom:0px;margin-top:25px;">
              <img src="./icons/search2.png" style="height:35px"> 실종/보호 아동조회</h2>
          </div>
        </div>
        <section style="background-color:white">
          <div class="body" align="center">
            <p>
              <b style="font-size:15px">찾고있는중인 실종아동 또는 보호중인 아동을 검색할 수 있습니다.</b>
            </p>

            <TABLE class="table_search2 margin_t8 float_l" style="WIDTH: 413px" summary="대상,성별,이름,발생일,당시나이,신체특징,발생장소 검색"
              sizcache="5" sizset="98" border="0" >
              <CAPTION></CAPTION>
              <COLGROUP>
                <COL width="25%">
                <COL width="55%">
                <COL width="*">
              </COLGROUP>
              <TBODY sizcache="5" sizset="98">
                <TR height="30px">
                  <TH align="center">검색 방법</TH>
                  <TD>
                    <input id="srchType_img" name="srchType" value="img" type="radio" onclick="selType('img')"
                      checked="true"> <label for="srchType_img">이미지 검색</label>
                    <input id="srchType_inf" name="srchType" value="inf" type="radio" onclick="selType('inf')"
                      style="margin-left:30px"> <label for="srchType_inf">정보 검색</label>
                  </TD>
                  <TD rowspan="2">
                    <div id="imgDiv">
                      <img src="@sample.gif" width="70px" id="img" name="img"/>  
                    </div>
                  </TD>
                </TR>
                <TR>
                  <TH align="left" colspan="3">
                    <div id="imgSrch">
                      <form id="getImageForm">
                          &nbsp;이미지 선택 &nbsp;&nbsp;&nbsp;
                        <input name="imagePath" type="file" id="imagePath" style="width:230px;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"
                          accept="image/jpeg, image/png"/>
                      </form>
                    </div>

                    <div id="infSrch" hidden="true">
                      이름:
                      <INPUT id="babyName" title="이름 입력" class="inputBox middle" style="WIDTH: 74px; margin-right:20px">
                      나이:
                      <INPUT id="age" title="나이 입력" class="inputBox middle" style="WIDTH: 42px; margin-right:20px"
                        onKeyup="this.value=this.value.replace(/[^0-9]/g,'');">
                      연락처:
                      <INPUT id="phoneNumber" title="연락처 입력" class="inputBox middle" style="WIDTH: 94px"
                        onKeyup="this.value=this.value.replace(/[^0-9]/g,'');">
                      <br>
                      <div style="margin-top:5px">특이사항:
                        <INPUT id="etcSpfeatr" title="특이사항 입력" class="inputBox middle" style="WIDTH: 327px">
                      </div>
                    </div>
                  </TH>
                </TR>
                <TR>
                  <TD align="center" colspan="3">
                    <button class="btn focus" id="btn_inq">조회</button>
                  </TD>
                </TR>
              </TBODY>
            </TABLE>
        </section>
        <div style="background-color:white"><br><br></div>
        <!-- <table class="table classic hover">
          <thead>
            <tr>
              <th style="text-align:center">이름</th>
              <th style="text-align:center">사진</th>
              <th style="text-align:center">나이</th>
              <th style="text-align:center">연락처</th>
              <th style="text-align:center">특이사항</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>김재롱</td>
              <td>
                <img src="dog.jpg" alt="절미 얼굴 사진">
              </td>
              <td>8세</td>
              <td>010-777-8888</td>
              <td>
                왼쪽 눈 아래 점이 있어용<br><br>
                <button class="btn small focus" onclick="alert('details')">상세</button>
              </td>
            </tr>
          </tbody>
        </table> -->
        <div id="list_table"></div>
      </div>
    </div>
  </div>
  </div>
  <script>
    $(function () {

        // getBabiesCount 를 호출하고, 해당 결과를 화면에 갱신
        $.ajax({
          url: '/getBabiesCount',
          type: 'GET'
        }).done(function (data) {

          $("#totRegChain").text(data);
        });

      // getTotalSupply router를 호출하고, 해당 결과를 화면에 갱신
      $.ajax({
        url: '/getTotalSupply',
        type: 'GET'
      }).done(function (data) {
        
        $("#totToken").text(data);
      });

        $.ajax({
          url: '/getBalance',
          data: {
            tgtAccountIdx: "1"
          }, // HTTP 요청과 함께 서버로 보낼 데이터
          type: 'GET'
        }).done(function (data) {
          $("#yourToken").text(data);
        });

      $("#btn_inq").on("click", function (e) {
        var sel = $(':radio[name="srchType"]:checked').val();

        if ('img' == sel) {
          // 이미지 검색
          var form = $('#getImageForm')[0];
          var formData = new FormData(form);

          $.ajax({
            url: '/getSimilarity',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false
          }).done(function (data) {
            var resultArray = [];
            for (var i = 0; i < data.length; i++) {
              $.ajax({
                url: '/getBabyByFilename',
                type: 'POST',
                data: {
                  "filename": data[i][0],
                  "sim": data[i][1]
                }
                // , async: false
              }).done(function (data1) {
                resultArray.push(data1);

                if (resultArray.length == data.length) { // 갯수가 채워지면 결과 반환
                  getList(sel, resultArray);
                }
              });
            }
          });
        } else if ('inf' == sel) {
          // 정보 검색
          $.get('/getAllBabies', function (data) {
            var resultArray = [];
            for (var i = 0; i < data.length; i++) {
              if (data[i].name.indexOf($('#babyName').val()) != -1 &&
                (('' == $('#age').val()) ? true : data[i].age == $('#age').val()) &&
                data[i].phoneNumber.indexOf($('#phoneNumber').val()) != -1 &&
                data[i].etcSpfeatr.indexOf($('#etcSpfeatr').val()) != -1) {
                resultArray.push(data[i]);
              }
            }
            getList(sel, resultArray);
          });
        }

      });
    });

    //창 닫기 (메인화면으로)
    function closePop() {
      //parent.$('#popupcontent').hide();      
      parent.location.href = "../index.html";
    }

    //상단 테마 바꾸기
    function changeTheme(theme) {
      $("#ui_theme").attr("href", "../../lib/jui/css/ui-" + theme + ".min.css");
      $("#grid_theme").attr("href", "../../lib/jui/css/grid-" + theme + ".min.css");
      $("#index_theme").attr("href", "../../gallery/admintool/index-" + theme + ".css");

      for (var i = 0, len = chart_list.length; i < len; i++) {
        if (chart_list[i].setTheme) {
          chart_list[i].setTheme(theme);
        } else {
          chart_list[i].chart.setTheme(theme);
        }
      }
    }

    function selType(type) {
      if (type == "img") {
        $('#imgSrch').show();
        $('#imgDiv').show();
        $('#infSrch').hide();        
      } else {
        $('#imgSrch').hide();
        $('#imgDiv').hide();
        $('#infSrch').show();
        
      }
    }

    // 조회 결과 출력
    function getList(type, data) {
      $('#list_table').empty();

      var content = '';

      content += '<table class="table classic hover">';
      content += '  <colgroup>';
      if ('img' == type) {
        content += '    <col width="10%">';
        content += '    <col width="20%">';
        content += '    <col width="6%">';
        content += '    <col width="18%">';
        content += '    <col width="31%">';
        content += '    <col width="10%">';
      } else if ('inf' == type) {
        content += '    <col width="12%">';
        content += '    <col width="22%">';
        content += '    <col width="8%">';
        content += '    <col width="20%">';
        content += '    <col width="33%">';
      }
      content += '  </colgroup>';

      content += '  <thead>';
      content += '    <tr>';
      content += '      <th style="text-align:center">이름</th>';
      content += '      <th style="text-align:center">사진</th>';
      content += '      <th style="text-align:center">나이</th>';
      content += '      <th style="text-align:center">연락처</th>';
      content += '      <th style="text-align:center">특이사항</th>';
      if ('img' == type) {
        content += '      <th style="text-align:center">유사도</th>';
      }
      content += '    </tr>';
      content += '  </thead>';

      content += '  <tbody>';
      if (data.length < 1) {
        var colspan = 5;
        if ('img' == type) {
          colspan = 6;
        }
        content += '<tr><td style="text-align:center" colspan=' + colspan + '>조회 결과가 없습니다.</td></tr>';
      } else {
        for (var i = 0; i < data.length; i++) {
          content += '<tr>';
          content += '<td style="text-align:center">' + data[i].name + '</td>'
          content += '<td style="text-align:center"><div style="width:100%"><img src="/imgs?filename=' + data[i].filename + '" width="100%"></div></td>'
          content += '<td style="text-align:center">' + data[i].age + '</td>'
          content += '<td style="text-align:center">' + data[i].phoneNumber + '</td>'
          content += '<td>' + data[i].etcSpfeatr + '</td>'
          if ('img' == type) {
            content += '<td style="text-align:center">' + (data[i].sim * 100).toFixed(2) + '%</td>'
          }
          content += '</tr>';
        }
      }
      content += '  </tbody>';
      content += '</table>';

      $('#list_table').append(content);
    }

    //이미지 미리보기 set
    $(document).ready(function () {
        var opt = {
          img: $('#img')
        };
        $('#imagePath').setPreview(opt, 0);
      });

      //이미지 미리보기 set
      $.fn.setPreview = function (opt, index) {
        var defaultOpt = {
          inputFile: $(this),
          img: null
        };

        $.extend(defaultOpt, opt);

        var previewImage = function () {
          if (!defaultOpt.inputFile || !defaultOpt.img) return;
          var inputFile = defaultOpt.inputFile.get(0);
          var img = defaultOpt.img.get(0);

          // FileReader
          if (window.FileReader) {
            // image 
            if (!inputFile.files[0].type.match(/image\//)) return;

            // preview
            try {
              var reader = new FileReader();
              reader.onload = function (e) {
                img.src = e.target.result;
                img.style.width = defaultOpt.w + 'px';
                img.style.height = defaultOpt.h + 'px';
                img.style.display = '';
              }
              reader.readAsDataURL(inputFile.files[0]);
            } catch (e) {
              // exception...
            }
            // img.filters (MSIE)
          } else if (img.filters) {
            inputFile.select();
            inputFile.blur();
            var imgSrc = document.selection.createRange().text;
            img.src = imgSrc;
            img.style.display = '';
            // no support
          } else {
            // Safari5, ...
          }
        };

        // onchange
        $(this).change(function () {
          previewImage();
        });
      };
  </script>
</body>

</html>